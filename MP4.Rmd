---
title: "MP4"
output: 
  html_document:
    code_folding: TRUE

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(mdsr)
library(RMySQL)
library(tidyverse)
library(broom)
db <- dbConnect_scidb(dbname = "imdb")
```

```{r}

dv_sv_media <- db %>%
dbGetQuery("SELECT DISTINCT ci.person_id, mi.info, mi.movie_id, t.title, n.name, n.gender, ci.nr_order 
FROM movie_info AS mi 
JOIN info_type it ON it.id = mi.info_type_id  
JOIN title t ON t.id = mi.movie_id
JOIN kind_type kt ON kt.id = t.kind_id
JOIN cast_info ci ON ci.movie_id = mi.movie_id
JOIN name n ON n.id = ci.person_id
WHERE it.id = 97 AND (ci.nr_order IS NOT NULL AND n.gender IS NOT NULL) 
AND (mi.info LIKE '%domestic violence%' OR mi.info LIKE '%sexual violence%')
AND (t.kind_id = 1 or t.kind_id = 2 or t.kind_id = 3);")





v_media <- db %>%
dbGetQuery("SELECT DISTINCT ci.person_id, mi.info, mi.movie_id, t.title, n.name, n.gender, ci.nr_order 
FROM movie_info AS mi 
JOIN info_type it ON it.id = mi.info_type_id  
JOIN title t ON t.id = mi.movie_id
JOIN kind_type kt ON kt.id = t.kind_id
JOIN cast_info ci ON ci.movie_id = mi.movie_id
JOIN name n ON n.id = ci.person_id
WHERE it.id = 97 AND (ci.nr_order IS NOT NULL AND n.gender IS NOT NULL) 
AND (mi.info LIKE '%violence%')
AND (t.kind_id = 1 or t.kind_id = 2 or t.kind_id = 3);")

## Directors of movies rated for domestic or sexual violemce
directors <- db %>%
  dbGetQuery("SELECT n.name AS director, ci.person_id, n.gender, mi.info, t.title
FROM cast_info ci
JOIN name n ON n.id = ci.person_id
JOIN movie_info mi ON mi.movie_id = ci.movie_id
JOIN title t ON ci.movie_id = t.id
JOIN info_type it ON it.id = mi.info_type_id 
WHERE role_id = 8
AND (mi.info LIKE '%domestic violence%' OR mi.info LIKE '%sexual violence%' OR mi.info LIKE '%rape%' OR mi.info LIKE '%sexual assault%')
AND (t.kind_id = 1 or t.kind_id = 2 or t.kind_id = 3)
AND it.id = 97
AND n.gender IS NOT NULL;")

## Directors and producers for movies, tv movies, and tv series rated for sexual or domestic violence
directors_producers_media <- db %>%
  dbGetQuery("SELECT DISTINCT n.name AS director_producer, ci.person_id, n.gender, mi.info, t.title
FROM cast_info ci
JOIN name n ON n.id = ci.person_id
JOIN movie_info mi ON mi.movie_id = ci.movie_id
JOIN title t ON ci.movie_id = t.id
JOIN info_type it ON it.id = mi.info_type_id 
WHERE (role_id = 8 or role_id = 3)
AND (mi.info LIKE '%domestic violence%' OR mi.info LIKE '%sexual violence%' OR mi.info LIKE '%rape%' OR mi.info LIKE '%sexual assault%')
AND (t.kind_id = 1 or t.kind_id = 2 or t.kind_id = 3)
AND it.id = 97
AND n.gender IS NOT NULL;")

## Directors for movies, tv movies, and tv series rated for violence
directors_violence <- db %>%
  dbGetQuery("SELECT DISTINCT n.name AS director, ci.person_id, n.gender, mi.info, t.title
FROM cast_info ci
JOIN name n ON n.id = ci.person_id
JOIN movie_info mi ON mi.movie_id = ci.movie_id
JOIN title t ON ci.movie_id = t.id
JOIN info_type it ON it.id = mi.info_type_id 
WHERE role_id = 8
AND (mi.info LIKE '%violence%')
AND (t.kind_id = 1 or t.kind_id = 2 or t.kind_id = 3)
AND it.id = 97
AND n.gender IS NOT NULL;")

## OR for answering: Do female directors have higher odds of directing a movie rated for a type of sexual violence than male directors?
directors_v_clean <- directors_violence %>%
  mutate(gender_num = ifelse(gender == 'm', 0, 1)) %>%
  mutate(dv = grepl('domestic violence', info, ignore.case = TRUE)) %>%
  mutate(dv = ifelse(dv == FALSE, 0, 1)) %>%
  mutate(r = grepl('rape', info, ignore.case = TRUE)) %>%
  mutate(r = ifelse(r == FALSE, 0, 1)) %>%
  mutate(sv = grepl('sexual violence', info, ignore.case = TRUE)) %>%
  mutate(sv = ifelse(sv == TRUE, 1, 0)) %>%
  mutate(dv_r_sv = ifelse(dv == 1 | r == 1 | sv == 1, 1, 0))

or_direct_sv <-glm(data = directors_v_clean, dv_r_sv~gender_num, family=quasibinomial(link="logit"))
summary(or_direct_sv)
exp(cbind(OR=coef(or_direct_sv), confint(or_direct_sv)))
##Answer: YES!!! When taking all movies rated for some kind of violence, female directors have significantly higher odds of being associated with a movie rated for domestic violence, rape, or sexual violence


## Directors and producers for movies, tv movies, and tv series rated for sexual or domestic violence, distinguished by role type
dp_distinct <- db %>%
  dbGetQuery("SELECT DISTINCT n.name, ci.person_id, n.gender, role_id, mi.info, t.title
FROM cast_info ci
JOIN name n ON n.id = ci.person_id
JOIN movie_info mi ON mi.movie_id = ci.movie_id
JOIN title t ON ci.movie_id = t.id
JOIN info_type it ON it.id = mi.info_type_id 
WHERE (role_id = 8 or role_id = 3)
AND (mi.info LIKE '%domestic violence%' OR mi.info LIKE '%sexual violence%' OR mi.info LIKE '%rape%' OR mi.info LIKE '%sexual assault%')
AND (t.kind_id = 1 or t.kind_id = 2 or t.kind_id = 3)
AND it.id = 97
AND n.gender IS NOT NULL;")

## wrangling of this last dataset
sv_directors  <- dp_distinct %>%
  mutate(director = ifelse(role_id == 8, 1, 0)) %>%
  filter(director == 1) %>%
  mutate(gender_num = ifelse(gender == 'm', 0, 1)) %>%
  mutate(dv = grepl('domestic violence', info, ignore.case = TRUE)) %>%
  mutate(dv = ifelse(dv == FALSE, 0, 1)) %>%
  mutate(r = grepl('rape', info, ignore.case = TRUE)) %>%
  mutate(r = ifelse(r == FALSE, 0, 1)) %>%
  mutate(dv_r = ifelse(r == 1 | dv == 1, 1, 0))

## OR for answering question: Do female directors have higher odds of directing films rated for rape/domestic violence out of movies containing sexual violence? 
or_fem_direct <- glm(data = sv_directors, dv_r~gender_num, family=quasibinomial(link="logit"))
summary(or_fem_direct)
exp(cbind(OR=coef(or_fem_direct), confint(or_fem_direct)))
## Answer: not signficant, but this is interesting and unexpected! 
```


Data Wrangling for Orientation: 
```{r}

dp_model_set <- directors_producers_media %>%
  mutate(gender_num = ifelse(gender == 'm', 0, 1)) %>%
  mutate(dv = grepl('domestic violence', info, ignore.case = TRUE)) %>%
  mutate(dv = ifelse(dv == FALSE, 0, 1)) %>%
  mutate(r = grepl('rape', info, ignore.case = TRUE)) %>%
  mutate(r = ifelse(r == FALSE, 0, 1))
  
## OR for odds that a movie rated for domestic violence will be directed/produced by a female (out of movies rated for types of sexual violence)
or_gender_dv <-glm(data = dp_model_set, dv~gender_num, family=quasibinomial(link="logit"))
summary(or_gender_dv)
exp(cbind(OR=coef(or_gender_dv), confint(or_gender_dv)))
## Answer: Females do not have significantly higher odds of directing/producing a movie rated for domestic violence out of movies rated fro types of sexual violence. 


## OR for odds that a movie rated for rape will be directed/produced by a female (out of movies rated for types of sexual violence)
or_gender_r <-glm(data = dp_model_set, r~gender_num, family=quasibinomial(link="logit"))
summary(or_gender_r)
exp(cbind(OR=coef(or_gender_r), confint(or_gender_r)))
## Answer: females do not have significantly higher odds of directing/producing a movie rated for rape out of movies rated for all types of sexual violence. 

## OR for odds that media rated for domestic violence/rape will be directed/produced by a female (out of media rated for all types of violence)
directors_producers_media <- directors_producers_media %>%
  mutate(gender_num = ifelse(gender == 'm', 0, 1)) %>%
  mutate(dv = grepl('domestic violence', info, ignore.case = TRUE)) %>%
  mutate(dv = ifelse(dv == FALSE, 0, 1)) %>%
  mutate(r = grepl('rape', info, ignore.case = TRUE)) %>%
  mutate(r = ifelse(r == FALSE, 0, 1)) %>%
  mutate(dvr = ifelse(r == 1 | dv == 1, 1, 0))

or_gender_dvr <- glm(data = directors_producers_media, dvr~gender_num, family=quasibinomial(link = "logit"))
summary(or_gender_dvr)
exp(cbind(OR=coef(or_gender_dvr), confint(or_gender_dvr)))
## Not significant

v_media <- v_media %>%
  mutate(gender_num = ifelse(gender == 'm', 0, 1)) %>%
  mutate(dv = grepl('domestic violence', info, ignore.case = TRUE)) %>%
  mutate(dv = ifelse(dv == FALSE, 0, 1)) %>%
  mutate(r = grepl('rape', info, ignore.case = TRUE)) %>%
  mutate(r = ifelse(r == FALSE, 0, 1))

## OR for odds that a female actress will be associated with a move containing domestic violence (out of all movies rated for violence)
or_gender_v <- glm(data = v_media, dv~gender_num, family=quasibinomial(link="logit"))
summary(or_gender_v)
exp(cbind(OR=coef(or_gender_v), confint(or_gender_v)))
## Answer: Female actresses have significantly higher odds of being associated with a movie rated for domestic violence than male actors


## added a variable for if an actor/actress is in top five billed, will be using for analysis of following question: Among movies rated for rape/domestic violence, are women more or less likely to be billed highly?
v_media_top_rdv <- v_media %>%
  mutate(ranked = ifelse(nr_order <= 5, 1, 0)) %>%
  filter(r == 1 | dv == 1)


or_billed_rdv <- glm(data = v_media_top_rdv, ranked~gender_num, family=quasibinomial(link="logit"))
summary(or_billed_r)
exp(cbind(OR=coef(or_billed_r), confint(or_billed_r)))
## Answer: Females do not have significantly different odds of being billed highly in movies rated for rape/domestic violence than male actors
```

Saving odds ratio results as tidy data frames; only p-values:
```{r}

make_table <- function(or_arg){
  tidy(or_arg) %>%
    select(term, p.value) %>%
    filter(term == "gender_num")
}

or_list <- list(or_direct_sv, or_billed_rdv, or_fem_direct, or_gender_dv, or_gender_dvr, or_gender_r, or_gender_v)

big_table <- lapply(or_list, make_table) %>%
  bind_rows()

tidy_direct_sv <- tidy(or_direct_sv) %>%
  select(term, p.value) %>%
  filter(term == "gender_num") %>%
  mutate(focus_var = "direct_sv")
tidy_billed_rdv <- tidy(or_billed_rdv) %>%
  select(term, p.value) %>%
  filter(term == "gender_num") %>%
  mutate(focus_var = "billed_rdv")
tidy_fem_direct <- tidy(or_fem_direct) %>%
  select(term, p.value) %>%
  filter(term == "gender_num") %>%
  mutate(focus_var = "fem_direct")
tidy_gender_dv <- tidy(or_gender_dv) %>%
  select(term, p.value) %>%
  filter(term == "gender_num") %>%
  mutate(focus_var = "gender_dv")
tidy_gender_dvr <- tidy(or_gender_dvr) %>%
  select(term, p.value) %>%
  filter(term == "gender_num") %>%
  mutate(focus_var = "gender_dvr")
tidy_gender_r <- tidy(or_gender_r) %>%
  select(term, p.value) %>%
  filter(term == "gender_num") %>%
  mutate(focus_var = "gender_r")
tidy_gender_v <- tidy(or_gender_v) %>%
  select(term, p.value) %>%
  filter(term == "gender_num") %>%
  mutate(focus_var = "gender_v")
```


